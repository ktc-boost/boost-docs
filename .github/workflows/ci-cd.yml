name: CI/CD Workflow

on:
  push:
    branches:
      - main
      - develop
      - "feat/**"
      - "fix/**"
      - "refactor/**"
      - "style/**"
      - "release/**"
  pull_request:
    branches:
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  # 0ï¸âƒ£ Lint
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run lint
        run: pnpm lint

  # 1ï¸âƒ£ Build & Test
  build:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm run build
      - name: Test
        run: pnpm test || true

      # Build/Test ì‹¤íŒ¨ ì‹œ PR ì½”ë©˜íŠ¸ + ë‹«ê¸°
      - name: Fail PR if build/test fails
        if: ${{ failure() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = ${{ github.event.pull_request.number }};
            const updated_title = `[CI FAIL] ${{ github.event.pull_request.title }}`;
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr,
              body: 'ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
              event: 'REQUEST_CHANGES'
            });
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr,
              title: updated_title,
              state: 'closed'
            });

  # 2ï¸âƒ£ Preview ë°°í¬ (feat/*, fix/*, refactor/*, style/*, develop PR)
  deploy-preview:
    if: ${{ !startsWith(github.ref, 'refs/heads/main') }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Vercel CLI ì„¤ì¹˜
        run: npm install -g vercel@latest
      - name: Vercel Preview Deploy
        id: deploy
        run: |
          DEPLOY_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: PR ì½”ë©˜íŠ¸ì— Preview URL ì‘ì„±
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.url }}';
            const comment = `ğŸš€ **ë¯¸ë¦¬ë³´ê¸° ë°°í¬ ì™„ë£Œ!**\n\nğŸ“ **ë°°í¬ URL:** ${deployUrl}\nâœ… **ë¸Œëœì¹˜:** \`${{ github.head_ref }}\`\nâœ… **ì»¤ë°‹:** \`${{ github.sha }}\``;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # 3ï¸âƒ£ Production ë°°í¬ (main push)
  deploy-production:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Vercel CLI ì„¤ì¹˜
        run: npm install -g vercel@latest
      - name: Vercel Production Deploy
        id: deploy-prod
        run: |
          DEPLOY_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: ìš´ì˜ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ìš´ì˜ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“ ë°°í¬ URL: ${{ steps.deploy-prod.outputs.url }}"
